<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- load jquery first!!! -->
    <script src="js/jquery-3.4.1.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <title>Point Cloud Visualization</title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            width: 100%;
            height: 100%;
        }
    </style>

    <script src="js/three.js"></script>
    <script src="js/TrackballControls.js"></script>
    <script>

        // ----- for three js render
        var config = {
            bg_color: 0x000000,
            material: new THREE.MeshBasicMaterial({color: 0x4169E1}), // default color
        };

        var camera, scene, renderer, controls;
        var current_points, current_container;

        function randFloat(low, high) {
            return low + Math.random() * (high - low);
        }

        function init(points, container) {
            var aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(60, aspect);
            camera.position.z = 50;

            scene = new THREE.Scene();

            var geometry = new THREE.CubeGeometry(0.1, 0.1, 0.1, 1, 1, 2);
            for (var i = 0; i < points.length; i++) {
                var gi = geometry.clone();
                gi.translate(points[i][0], points[i][1], points[i][2]);
                var point = new THREE.Mesh(gi, config.material);

                scene.add(point);
            }

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(config.bg_color);

            container.empty();
            container.append(renderer.domElement);
        }

        function createControls() {
            controls = new THREE.TrackballControls(camera, renderer.domElement);

            controls.rotateSpeed = 2.0;
            controls.zoomSpeed = 20;
            controls.panSpeed = 0.8;

            controls.staticMoving = true;
            controls.dynamicDampingFactor = 0.3;

            controls.addEventListener('change', render);
        }

        function render() {
            renderer.render(scene, camera);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update()
        }

        window.addEventListener('resize', function() {
            if (camera) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        function showPointCloud(points, container) {
            // too many points may cause memory crash
            points = points.slice(0, 4000);

            current_points = points;
            current_container = container;

            init(points, container);
            createControls();
            render();
            animate();
        }

        // --------- for file uploader

        function parse_line(line_text) {
            if (!line_text) {
                return null;
            }

            var splits = [' ', ',', ', '];
            for (var i = 0; i < splits.length; i++) {
                var result = line_text.split(splits[i]);
                if (result.length === 3 || result.length === 6) {
                    for (var j = 0; j < result.length; j ++) {
                        result[j] *= 10;
                    }
                    return result;
                }
            }

            return null;
        }

        function handlerFileSelected(evt) {
            if (!evt.target.files || ! evt.target.files[0]) {
                alert("No file uploaded");
                return;
            }

            var f = evt.target.files[0];
            var reader = new FileReader();
            reader.onload = function(event) {
                var contents = event.target.result;
                var lines = contents.split('\n');
                var parse_line_result;

                // detect color information
                var info_len = 0;
                var first_line = lines[0];
                parse_line_result = parse_line(first_line);
                if (!parse_line_result) {
                    alert('Parse Error');
                    return;
                }
                info_len = parse_line_result.length;

                var points = [];
                for (var i = 0; i < lines.length; i++) {
                    parse_line_result = parse_line(lines[i]);
                    if (!parse_line_result || (parse_line_result.length !== info_len)) {
                        continue;
                    }
                    points.push(parse_line_result);
                }

                $('#upload_file_container').hide();
                $('#render_div').show();

                showPointCloud(points, $('#render_div'));

                $('#tip_panel').modal();
            };
            reader.readAsText(f);
        }

        // ---- for option panel

        function save_config() {
            var updated = false;

            const background_color = $("#bg_color").val();
            try {
                const bg_color = parseInt(background_color);
                config.bg_color = bg_color;
                updated = true;
            }
            catch (error) {
                console.log('background color error!');
            }

            const point_color = $("#point_color").val();
            try {
                const pt_color = parseInt(point_color);
                config.material = new THREE.MeshBasicMaterial({color: pt_color});
                updated = true;
            }
            catch (error) {
                console.log('background color error!');
            }

            if (updated) {
                showPointCloud(current_points, current_container);
            }
        }


        // ----- document ready
        $(document).ready(function(){
            $('#upload_file_container').show();
            $('#render_div').hide();

            const file_input = document.getElementById("point_cloud_file");
            file_input.addEventListener("change", handlerFileSelected);

            $(document).on('keydown', function(event) {
                if ($('#option_panel').is(":visible")) {
                    return;
                }

                if (!$('#render_div').is(":visible")) {
                    return;
                }

                const key_code = (event.keyCode ? event.keyCode : event.which);
                if (key_code=== 79) {
                    // o for option
                    $('#option_panel').modal('toggle');
                }
            });

            $('#save_config').click(function() {
                save_config();
            });
        });

    </script>
</head>

<body>
    <div class="container mt-3" id="upload_file_container">
        <h2>Point Cloud Visualization Tool</h2>
        <p>File format:</p>
        <ul>
            <li>plain txt file</li>
            <li>each line represent on point</li>
            <li>"x y z" or "x,y,z" or "x, y, z" are all OK</li>
            <li><a href="res/point_cloud_example1.txt" target="_blank">example1</a>, <a href="res/point_cloud_example2.txt" target="_blank">example2</a></li>
        </ul>
        <div class="custom-file mb-3">
            <input type="file" class="custom-file-input" id="point_cloud_file" name="filename">
            <label class="custom-file-label" for="point_cloud_file">Choose point cloud file</label>
        </div>
    </div>

    <div id="render_div"></div>

    <!-- option panel Modal -->
    <div class="modal fade" id="option_panel" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Render Options</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">Background Color</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" id="bg_color" placeholder="0x000000">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label">Point Color</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control" id="point_color" placeholder="0x4169E1">
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save_config" data-dismiss="modal">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- tip Modal -->
    <div class="modal fade" id="tip_panel" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tips</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Press 'o' to open render options panel. 'o' is short for option.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</body>



</html>